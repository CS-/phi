<title>Phi - compute it yourself</title>
<style>
    #content {
        /*text-align: center;*/
        font-size: x-large;
        /*overflow: auto;*/
        /*word-wrap: break-word;*/
    }
    b {
        /*font-weight: normal;*/
    }
</style>
<script src="http://peterolson.github.com/BigInteger.js/BigInteger.min.js"></script>
<!-- <script src="bigint.js"></script> -->
<div id="content"></div>
<script>
    document.addEventListener("click", nomore, false);
    document.addEventListener("keyup", nomore, false);

    var enough = 0, 
        levels=10,
        startTime=Date.now(); //millisec
    
    function formatMSec(ms) {
        var sec = (ms / 1000) | 0;
        if (sec===0) return ms + 'ms';
        
        var min = (ms / 60000) | 0;
        if (min===0) return sec + 's ' + (ms-sec*1000) + 'ms';        
        
        var h = (ms / 3600000) | 0;
        if (h===0) return min + 'm ' + (sec-min*60) + 's';        
        return h + 'h ' + (min-h*60) + 'm';
    }

    function out(txt, append) {
        if (!append) content.innerHTML = '';
        document.getElementById('content').innerHTML += txt;
    }


    //so when you click or bash your keyboard furiously (4 times)
    //this nice little defunctor will use magic to give you your peace
    function nomore() { 
        if (enough++ == 4) {
            clearInterval(comp); //abracadaber
            var last=n1.toString();
            content.innerHTML+='...';

            out('<br>Latest Fibonacci #' + ith 
                 + ' computed is ~'
                 + last[0] + 'e' + last.length + '<br>' 
                 + 'Wasted ' 
                 + formatMSec(Date.now()-startTime) 
                 + ' to compute all this, hope you really need it!'
            , true);
        }
    }

    //special case, Do Not Use! look: starts with 1.
    function bcdiv(num, divisor, precision) {
        var r='1.', p=0, i=2, temp, halt=true;
        
        num=bigInt(num);
        while (p++ < precision) {
            num=num.mod(divisor).multiply(10);
            temp=num.divide(divisor).toString();
            r+=temp;
            if (halt) {
                if (temp !== phi[i++]) halt=false;
            } else break;
        }
        return r;
    }

    // ?? use?
    function makeColor(x) {
        var r=Math.min(~~(x/1) + 16, 255),
            g=Math.min(~~(x/1), 128);
        return '#' + r.toString(16).replace(/^(.)$/, '0$1') 
                   + (128-g).toString(16).replace(/^(.)$/, '0$1') 
                   + '00';
    }

    function alerting(ms, fib) {
        var slowness = (ms+'').length-2,
            slow = ['slowing', 
                    'slow', 
                    'crawling', 
                    'is squeezing every tranzistor'],
            extra = ['', 
                     'Please insert CPU...', 
                     'We should stop now!', 
                     'Bro do you even read this?'];
            console.log('Computation ' + slow[slowness] 
                        +' at ' + fib + 'th Fibonacci no. ' 
                        + ms + 'ms. ' + extra[slowness]);
    }

    var n0=bigInt(1), 
        n1=bigInt(1), 
        phi = '1',
        ith=2;
    var comp = setInterval(function () {
        var newphi=n1;
        n1 = n0.add(n1);
        n0 = newphi;
        
        var perf=Date.now();
        newphi = bcdiv(n1, n0, phi.length);
        perf=Date.now()-perf;

        if (perf > levels) {
            alerting(perf, ith);
            levels*=phi; //because PHI
        }

        //replacing everything? wth, it's supposed to be ineffective
        out(
            //hacked line to break line
            newphi.split('').join('<wbr>') // or '&#173;'
        );
                
        ith++;
        phi = newphi;
    }, 5);
</script>
